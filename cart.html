<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Shopping Cart - DNA Games</title>
    <link rel="stylesheet" href="assets/css/style.css" />
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <a href="index.html" class="logo" style="text-decoration: none; color: inherit;">
                    <div class="logo-icon">
                        <img src="images/dna-logo.png" alt="DNA Games Logo" class="dna-logo-img">
                    </div>
                    <span class="logo-text">DNA Games</span>
                </a>

                <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" placeholder="Search for games, software, or bundles..." id="searchInput" />
                    </div>
                </div>

                <!-- Right Side -->
                <div class="header-actions">
                    <div class="cart-icon" onclick="openCart()">
                        <span class="cart-symbol">üõí</span>
                        <span class="cart-count" id="cartCount">0</span>
                    </div>

                    <div class="user-icon" onclick="openUserMenu()">
                        <span class="user-symbol">üë§</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <div class="content-wrapper">
                <h1 style="margin-bottom: 2rem; font-size: 2rem; font-weight: 700; color: #1e3c72;">Shopping Cart</h1>

                <div id="cartContainer">
                    <!-- Cart items will be loaded here -->
                </div>

                <div id="emptyCart" style="text-align: center; padding: 4rem 0; display: none;">
                    <h2 style="margin-bottom: 1rem; color: #9ca3af;">Your cart is empty</h2>
                    <p style="margin-bottom: 2rem; color: #64748b;">Add some games to get started!</p>
                    <a href="index.html" class="btn btn-primary">Continue Shopping</a>
                </div>

                <div id="cartSummary" style="margin-top: 2rem; display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.25rem; font-weight: 700; color: #1e3c72;">Total:</h3>
                        <span id="cartTotal" style="font-size: 1.5rem; font-weight: 700; color: #fbbf24;">$0.00</span>
                    </div>
                    <button id="checkoutBtn" class="btn btn-primary" style="width: 100%; padding: 0.75rem;">Proceed to
                        Checkout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
            <div class="container">
                <p>&copy; 2024 DNA Games. All rights reserved. | Trusted digital marketplace since 2020</p>
            </div>
        </div>
    </footer>

    <script>
        let cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');

        function loadCart() {
            const cartContainer = document.getElementById('cartContainer');
            const emptyCart = document.getElementById('emptyCart');
            const cartSummary = document.getElementById('cartSummary');
            const cartCount = document.getElementById('cartCount');

            if (cartItems.length === 0) {
                emptyCart.style.display = 'block';
                cartSummary.style.display = 'none';
                cartContainer.innerHTML = '';
            } else {
                emptyCart.style.display = 'none';
                cartSummary.style.display = 'block';
                renderCartItems();
                updateCartTotal();
            }

            cartCount.textContent = cartItems.length;
        }

        function renderCartItems() {
            const cartContainer = document.getElementById('cartContainer');
            cartContainer.innerHTML = '';

            cartItems.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';

                cartItem.innerHTML = `
                    <img src="${item.image}" alt="${item.title}" style="width: 100px; height: 60px; object-fit: cover; border-radius: 0.5rem;">
                    <div class="cart-item-content">
                        <div class="cart-item-title">${item.title}</div>
                        <div class="cart-item-details">Platform: ${item.platform}</div>
                        <div class="cart-item-details">Seller: ${item.seller_name}</div>
                    </div>
                    <div class="quantity-section">
                        <div class="quantity-label">Quantity</div>
                        <div class="quantity-control">
                            <button onclick="updateQuantity(${index}, -1)" class="btn-quantity">-</button>
                            <span class="quantity-value">${item.quantity}</span>
                            <button onclick="updateQuantity(${index}, 1)" class="btn-quantity">+</button>
                        </div>
                    </div>
                    <div class="price-section">
                        <span class="current-price">$${(item.price * item.quantity).toFixed(2)}</span>
                        <span class="original-price">$${(item.original_price * item.quantity).toFixed(2)}</span>
                    </div>
                    <button onclick="removeFromCart(${index})" class="btn-remove">Remove</button>
                `;

                cartContainer.appendChild(cartItem);
            });
        }

        function updateQuantity(index, change) {
            if (cartItems[index]) {
                if (change === -1 && cartItems[index].quantity === 1) {
                    return; // Prevent decrement if quantity is 1
                }

                cartItems[index].quantity += change;

                localStorage.setItem('cartItems', JSON.stringify(cartItems));
                loadCart();
            }
        }


        function removeFromCart(index) {
            if (confirm('Remove this item from cart?')) {
                cartItems.splice(index, 1);
                localStorage.setItem('cartItems', JSON.stringify(cartItems));
                loadCart();
            }
        }

        function updateCartTotal() {
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
        }

        async function proceedToCheckout() {
            if (cartItems.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            const total = cartItems.reduce((sum, item) => sum + (parseFloat(item.price) * parseInt(item.quantity)), 0);
            const gameNames = cartItems.map(item => `${item.title} (x${item.quantity})`).join(', ');

            const checkoutData = {
                totalAmount: total.toFixed(2),
                gameNames: gameNames,
                cartItems: cartItems
            };

            try {
                const response = await fetch('set_checkout_session.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(checkoutData)
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = 'checkout.php';
                } else {
                    alert('Failed to initialize checkout session. Please try again.');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        function openCart() {
            // Already on cart page
        }

        function openUserMenu() {
            window.location.href = 'login.php';
        }

        // Initialize cart on page load
        document.addEventListener('DOMContentLoaded', loadCart);

        // Attach event listener to checkout button
        document.getElementById('checkoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            proceedToCheckout();
        });
    </script>
</body>

</html>